#!/bin/bash

# Get the directory where the script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CSV_FILE="$SCRIPT_DIR/dataset"

# Function to show help
show_help() {
    echo "Usage: $0 [--resource <resource>] [--type <type>] [--help]"
    echo ""
    echo "Options:"
    echo "  --resource, -r <resource>  Filter by resource"
    echo "  --type, -t <type>          Filter by type"
    echo "  --help, -h                 Show this help message"
    echo ""

    if [[ -f "$CSV_FILE" ]]; then
        echo "Available resources:"
        tail -n +2 "$CSV_FILE" | cut -d',' -f1 | sort -u | sed 's/^/  - /'
        echo ""
        echo "Available types:"
        tail -n +2 "$CSV_FILE" | cut -d',' -f2 | sort -u | sed 's/^/  - /'
    fi

    exit 0
}

# Parse command line arguments
RESOURCE=""
TYPE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --resource|-r)
            RESOURCE="$2"
            shift 2
            ;;
        --type|-t)
            TYPE="$2"
            shift 2
            ;;
        --help|-h)
            show_help
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [--resource <resource>] [--type <type>] [--help]"
            exit 1
            ;;
    esac
done

# Check if dataset file exists
if [[ ! -f "$CSV_FILE" ]]; then
    echo "Error: dataset file not found in $SCRIPT_DIR"
    exit 1
fi

# Read and process the CSV file
{
    # Read the header
    IFS=',' read -r col1 col2 col3 col4
    # Output header with proper alignment
    printf "%-25s %-15s %-30s %-s\n" "$col1" "$col2" "$col3" "$col4"

    # Process data rows
    while IFS=',' read -r resource type command description; do
        # Apply filters if specified
        if [[ -n "$RESOURCE" && "$resource" != "$RESOURCE" ]]; then
            continue
        fi
        if [[ -n "$TYPE" && "$type" != "$TYPE" ]]; then
            continue
        fi

        # Remove quotes from command and description
        command="${command//\"/}"
        description="${description//\"/}"

        # Output row with proper alignment
        printf "%-25s %-15s %-30s %-s\n" "$resource" "$type" "$command" "$description"
    done
} < "$CSV_FILE"
